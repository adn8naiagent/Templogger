name: Apply Database Migration After Merge
on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  migrate:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1
      
      - name: Generate Migration
        id: migration
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_DEV_PROJECT_REF }}
          
          # Standard diff - captures everything including RLS
          supabase db diff \
            --linked \
            --db-url "${{ secrets.SUPABASE_PROD_DB_URL }}" \
            --file migration.sql
          
          # Safety checks
          if [ -s migration.sql ]; then
            echo "📋 Migration includes:"
            grep -E "(CREATE POLICY|ALTER POLICY|DROP POLICY)" migration.sql || echo "No RLS changes"
            
            if grep -iE "(DROP TABLE|DROP COLUMN|DELETE FROM|TRUNCATE)" migration.sql; then
              echo "::error::❌ DESTRUCTIVE OPERATIONS DETECTED!"
              exit 1
            fi
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Apply Migration
        if: steps.migration.outputs.has_changes == 'true'
        run: |
          psql "${{ secrets.SUPABASE_PROD_DB_URL }}" -f migration.sql
          echo "✅ Migration completed (including RLS policies)"
