# Agent Database Schema Change Workflow

## ğŸ”’ Code Safety - CRITICAL

**NEVER PUSH TO MAIN BRANCH ON GITHUB. YOU ARE UNAUTHORIZED FROM EVERY TOUCHING THIS BRANCH. ONLY EVER PUSH TO DEV**

- Main branch is production-protected
- All changes must go through dev branch first
- Use pull requests for code review
- Never force push to any branch
- Always verify current branch before pushing

## Overview

This document outlines the automated database schema change workflow for AI agents (Claude Code, Replit Agent, etc.) working on this project.

## ğŸ¯ Goal

When developing features that require database schema changes, agents should:
1. âœ… Automatically update Railway dev database
2. âœ… Generate proper Prisma migration files  
3. âœ… Prepare changes for production deployment via GitHub Actions

## ğŸ”„ Automated Workflow

### Step 1: Modify Schema (Agent Action)
When a feature requires database changes, modify `prisma/schema.prisma`:

```typescript
// Example: Adding a new field to users table
model users {
  id                    String    @id @default(dbgenerated("gen_random_uuid()"))
  email                 String    @unique
  // ... existing fields ...
  
  // NEW FIELD - Agent adds this
  new_feature_field     String?   @db.VarChar
}
```

### Step 2: Generate Migration (Agent Action)
After modifying schema.prisma, run:

```bash
# Option A: Use helper script
./scripts/agent-db-change.sh

# Option B: Manual Prisma command
unset DATABASE_URL && npx prisma migrate dev --name "add_new_feature_field"
```

This automatically:
- âœ… Creates migration file in `prisma/migrations/`
- âœ… Applies changes to Railway dev database
- âœ… Updates Prisma client

### Step 3: Commit Changes (Agent Action)
```bash
git add prisma/
git commit -m "Add new feature field to users table

- Added new_feature_field to support X functionality
- Migration applied to Railway dev database
- Ready for production deployment"
```

### Step 4: Production Deployment (Automatic)
When PR is merged to main:
- âœ… GitHub Actions runs safety checks
- âœ… Deploys migration to Railway prod database
- âœ… Production database updated automatically

## ğŸ› ï¸ Agent Implementation

### For Claude Code / AI Agents
```bash
# 1. Agent modifies prisma/schema.prisma directly using Edit tool

# 2. Agent runs migration generation
./scripts/agent-db-change.sh

# 3. Agent commits the changes
git add prisma/
git commit -m "Feature: Add database schema for [feature_name]"
```

### File Structure
```
prisma/
â”œâ”€â”€ schema.prisma              # â† Agent modifies this
â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ 20250829_baseline/     # Original schema
â”‚   â””â”€â”€ 20250829_new_feature/  # â† Auto-generated by agent
â””â”€â”€ ...
```

## ğŸ” Safety & Validation

### Automatic Safety Checks
GitHub Actions validates migrations for:
- âŒ `DROP TABLE` / `DROP COLUMN` (destructive)
- âŒ `DELETE FROM` / `TRUNCATE` (data loss)  
- âŒ `ALTER COLUMN TYPE` (breaking changes)
- âœ… `ADD COLUMN` (safe)
- âœ… `CREATE TABLE` (safe)
- âœ… `CREATE INDEX` (safe)

### Migration Naming Convention
- Manual: `add_user_preferences`
- Auto: `auto_20250829123456` (timestamp-based)

## ğŸš€ Benefits

### For Agents
- âœ… **Seamless**: Schema changes are part of normal feature development
- âœ… **Automatic**: No manual database operations required
- âœ… **Safe**: Built-in safety checks prevent destructive operations
- âœ… **Tracked**: All changes properly versioned and deployed

### For Developers  
- âœ… **Consistent**: All schema changes go through same pipeline
- âœ… **Reviewable**: Migration files visible in PRs
- âœ… **Deployable**: Automatic production deployment
- âœ… **Rollbackable**: Standard Prisma migration rollback support

## ğŸ§ª Testing the Workflow

### Test Example
```bash
# 1. Modify schema to add test field
echo 'test_field String?' >> prisma/schema.prisma

# 2. Generate migration
./scripts/agent-db-change.sh

# 3. Verify files created
ls prisma/migrations/*/

# 4. Check dev database
psql $DATABASE_URL -c "\d users"
```

## ğŸ”§ Troubleshooting

### Common Issues

**"Migration already exists"**
```bash
# Reset if needed
npx prisma migrate reset --force
```

**"Schema drift detected"**
```bash
# Pull current database state
npx prisma db pull --force
```

**"DATABASE_URL environment conflict"**
```bash
# Always unset before Prisma commands
unset DATABASE_URL
npx prisma migrate dev --name "your_migration"
```

## ğŸ“‹ Quick Reference

### Agent Checklist for Schema Changes
- [ ] Modify `prisma/schema.prisma`
- [ ] Run `./scripts/agent-db-change.sh`
- [ ] Verify migration files created
- [ ] Commit both schema.prisma + migration files
- [ ] Push to trigger production deployment

### Files Agents Should Modify
- âœ… `prisma/schema.prisma` (direct editing)
- âœ… Commit migration files (generated automatically)
- âŒ Never modify `prisma/migrations/*/migration.sql` directly
- âŒ Never modify Railway databases directly

This workflow ensures database changes are:
- **Automatic** during feature development
- **Safe** with built-in validations  
- **Deployable** through standard CI/CD
- **Trackable** with proper version control